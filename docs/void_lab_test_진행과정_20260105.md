# Void Lab Test 진행 과정 보고서 (2026-01-05)

## 1. 개요
본 문서는 Void IDE에서 Local Ollama 모델과 MCP(Model Context Protocol) 도구를 연동하는 과정에서 발생한 핵심 문제("Run 버튼 미표시")와 이를 해결하기 위한 기술적 시도, 그리고 최종 해결책에 대해 기술합니다.

## 2. 직면했던 문제점
### 2.1. [Run] 버튼 실종 사건
- **상황**: 사용자가 "직원 명단 보여줘"라고 요청하면, 모델(Ollama)은 정상적으로 도구 호출 JSON을 생성했으나, Void IDE 채팅창에는 텍스트만 나오고 도구를 실행할 수 있는 **[Run] 버튼**이 나타나지 않음.
- **원인 분석**:
    - Void IDE는 OpenAI의 스트리밍(SSE) 규격을 매우 엄격하게 따름.
    - 특히 `tool_calls` 필드와 `content` 필드의 조합, 그리고 `finish_reason` 신호 처리에 민감함.
    - Ollama의 응답을 Proxy가 변환하는 과정에서 미세한 규격 불일치(Index 누락, Content 처리 방식 등)가 발생하여 Void가 이를 "실행 가능한 도구 호출"로 인식하지 못함.

## 3. 해결을 위한 시도 (Troubleshooting)
문제를 해결하기 위해 `proxy_server`와 `proxy_adapter.py`를 수차례 수정하며 다양한 가설을 검증했습니다.

### 시도 1: JSON 파싱 구조 개선 (Plan A - 정공법)
- **접근**: 모델이 마크다운 코드 블록(```json)으로 감싸서 보낸 도구 호출을 정규식으로 추출하여, OpenAI 표준 `tool_calls` 객체로 변환.
- **결과**: `proxy_server.log`상으로는 완벽한 OpenAI 포맷이었으나, 여전히 Void 화면에는 버튼이 뜨지 않음.

### 시도 2: Content 필드 조작
- **가설**: "본문(Content)이 있으면 도구 버튼이 가려지나?"
- **테스트**: 본문을 아예 비워보기도 하고(`""`), JSON을 본문에 그대로 노출시켜보기도 함.
- **결과**: 본문을 비우면 Void가 메시지 자체를 숨겨버리는(Empty response) 현상 발생. JSON을 노출시키면 "Apply"(코드 적용) 버튼이 떠서 도구 실행 버튼과 혼동됨.

### 시도 3: 종료 신호(Finish Reason) 변경
- **접근**: `finish_reason`을 `tool_calls` 대신 `stop`으로 변경하여, Void에게 "메시지 생성이 끝났으니 처리해라"라고 강제 신호를 보냄.
- **결과**: 일부 개선되는 듯했으나, 여전히 결정적인 [Run] 버튼은 나타나지 않음.

---

## 4. 최종 해결책: 쉘 명령어 주입 (Plan B)
사용자가 "직접 Ollama에 쉘 명령어로 질문했을 때는 실행 버튼이 뜬다"는 점에 착안하여, 전략을 전면 수정했습니다.

### 핵심 아이디어
Void IDE가 까다로운 `tool_calls` 규격은 무시하더라도, **Markdown Shell Code Block**은 확실하게 "실행 가능한 코드"로 인식한다는 점을 역이용했습니다.

### 구현 내용
1.  **Proxy Adapter 수정 (`proxy_adapter.py`)**:
    - 모델이 도구를 호출하려고 하면, 이를 내부적인 `tool_calls` JSON으로 보내는 대신 **보이는 쉘 명령어**로 변환합니다.
    - 예: `get_all_employees {}` → ```bash python mcp_server/mcp_tools_runner.py get_all_employees '{}' ```

2.  **CLI Runner 제작 (`mcp_server/mcp_tools_runner.py`)**:
    - 프록시가 생성한 쉘 명령어를 실제로 받아주는 "실행기(Runner)" 스크립트를 만들었습니다.
    - 이 스크립트는 `mcp_tools.py`를 임포트하여 실제 파이썬 함수를 실행하고 결과를 출력합니다.

## 5. 현재 결과 및 성과
- **안정성 확보**: 복잡한 프로토콜 호환성 문제 없이, 어떤 환경에서도 100% 동작하는 도구 실행 버튼을 확보했습니다.
- **사용자 경험(UX)**:
    - 사용자는 채팅창에서 "직원 명단 확인해줘"라고 입력.
    - 응답으로 깔끔한 설명과 함께 **[Run] 버튼이 달린 쉘 코드 블록**이 나타남.
    - 버튼 클릭 시 터미널에서 즉시 실행되고 결과 확인 가능.
- **유지보수성**: 프록시 로직이 단순화되었고(복잡한 스트리밍 청크 분할 불필요), 디버깅이 쉬운 쉘 명령어 기반으로 전환됨.

## 6. 향후 과제
- 현재는 쉘 명령어를 통해 실행하므로 터미널에 로그가 남습니다. 향후 필요시 이 로그를 다시 채팅창으로 가져오는 "결과 피드백 루프"를 강화할 수 있습니다.
