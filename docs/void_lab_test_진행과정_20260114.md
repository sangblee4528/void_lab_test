# Void Lab Test 진행과정 (2026-01-14)

오늘의 주요 작업은 에이전트의 자율 실행 루프를 사용자 승인 기반의 **Human-in-the-Loop (HITL)** 방식으로 개편하고, 기술적 세부 사양을 문서화하는 것이었습니다.

---

## 1. 주요 변경 사항 요약

1.  **자율 실행 루프 제거 및 HITL 전환**: 에이전트가 서버 내부에서 스스로 반복 실행하던 로직을 제거하고, 사용자가 각 도구 실행을 승인/환경할 수 있도록 구조를 변경했습니다.
2.  **지능형 피드백 주입 (Feedback Injection)**: 도구 실행 실패 시, LLM이 스스로 원인을 분석하고 대안을 찾을 수 있도록 서버가 특수 가이드(`[SYSTEM FEEDBACK]`)를 자동으로 주입하는 기능을 추가했습니다.
3.  **파일 관리 도구 추가**: 피드백 루프 실습을 위해 `list_files` 및 `create_file` 도구를 새롭게 구현했습니다.
4.  **기술 중심 흐름도 업데이트**: 파일명, 함수명, 라인 번호가 명시된 상세 흐름도를 작성했습니다.

---

## 2. 소스 코드 상세 수정 내역

### 📂 agent_native_loop/agent_native_loop_server.py

#### 🛠️ `chat_completions` 함수 (라인 123-181)
*   **수정 전**: `for i in range(max_iterations):` 루프를 사용하여 내부에서 최대 5회 자율적으로 도구를 실행함.
*   **수정 후**: 내부 루프를 완전히 제거하고 1회성(Single Turn) 요청 처리 방식으로 변경.
*   **이유**: 도구 실행의 주도권을 사용자(Void IDE UI)에게 넘겨 **Accept/Reject**가 가능하도록 하기 위함입니다.
*   **추가된 로직**:
    ```python
    # 라인 141-154: 피드백 주입 로직
    if last_msg and last_msg.get("role") == "tool":
        content_obj = json.loads(last_msg.get("content"))
        if not content_obj.get("success"):
            # 에러 감지 시 가이드 주입
            feedback_guidance = "\n\n[SYSTEM FEEDBACK]\n도구 실행 중 오류가 발생했습니다..."
            last_msg["content"] += feedback_guidance
    ```
    *   **이유**: 사용자가 승인한 도구가 실패했을 때, 서버가 지능적인 해결 가이드를 LLM에게 전달하여 다음 턴에서 자가 수정(Self-Correction)이 발생하도록 유도합니다.

#### 🛠️ `generate_pseudo_stream_hitl` 함수 (라인 207-248)
*   **신규 추가**: 기존의 단순 텍스트 스트리밍 함수를 대체.
*   **이유**: HITL 방식에서는 LLM의 응답이 텍스트일 수도, `tool_calls`일 수도 있으므로, 두 가지 경우를 모두 OpenAI 규격에 맞게 SSE 스트림으로 변환하여 Void IDE에 전송해야 합니다.

---

### 📂 agent_native_loop/native_loop_tools.py

#### 🛠️ `list_files`, `create_file` 함수 추가 (라인 111-133)
*   **신규 추가**: 파일 목록 확인 및 파일 생성 기능 구현.
*   **이유**: "파일이 없으면 만들어서 해결하라"는 피드백 루프 시나리오를 실제로 테스트하기 위한 핵심 도구들입니다.

#### 🛠️ `NATIVE_TOOL_DEFS` 메타데이터 업데이트 (라인 176-200)
*   **수정 내용**: 새로운 도구들에 대한 규격(JSON Schema)을 추가.
*   **이유**: LLM에게 사용할 수 있는 새로운 도구들의 존재와 사용법(인자 형식)을 알려주기 위함입니다.

---

## 3. 문서 업데이트 내역

### 📂 docs/질문_native_loop_흐름도.md
*   **수정 내용**: Mermaid 다이어그램을 HITL(사용자 승인) 시퀀스로 교체하고, 서버 및 도구 코드의 실제 라인 번호와 스니펫을 상세히 기록.
*   **이유**: 개발자가 시스템의 구동 원리를 소스 코드 레벨에서 즉시 파악할 수 있도록 가독성을 높였습니다.

### 📂 docs/git_사용법.md
*   **수정 내용**: `git restore` 및 `git pull`을 이용한 **파일 복구 방법** 섹션 추가.
*   **이유**: 실수로 중요한 문서가 삭제되었을 때 안전하게 복구할 수 있는 가이드를 제공합니다.

---

## 4. 향후 계획
- 현재 8002 포트에서 가동 중인 HITL 서버를 통해 다양한 에러 시나리오(권한 문제, 환경 변수 누락 등)에서의 자가 수정 능력을 고도화할 예정입니다.
