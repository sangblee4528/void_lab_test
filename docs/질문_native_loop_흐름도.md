# ì§ˆë¬¸_native_loop_íë¦„ë„ (Flowchart)

ì´ ë¬¸ì„œëŠ” ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ì…ë ¥ëœ í›„, ì—ì´ì „íŠ¸ê°€ ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ê³  ì˜¤ë¥˜ ë°œìƒ ì‹œ í”¼ë“œë°± ë£¨í”„ë¥¼ í†µí•´ ììœ¨ì ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ì „ì²´ ê³¼ì •ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## 1. ì „ì²´ íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
sequenceDiagram
    participant Void as Void IDE<br/>(ì±„íŒ…ì°½)
    participant Agent as agent_native_loop_server.py<br/>(127.0.0.1:8002)
    participant Tools as native_loop_tools.py<br/>(ë‚´ì¥ ë„êµ¬)
    participant DB as SQLite DB<br/>(agent_native_loop_data.db)
    participant LLM as Ollama/vLLM<br/>(127.0.0.1:11434)

    Void->>Agent: POST /v1/chat/completions<br/>{"messages": [{"role": "user", "content": "a.txt í™•ì¸í•´ì¤˜"}]}
    
    Note over Agent: chat_completions() ììœ¨ ë£¨í”„ ì‹œì‘
    
    loop Autonomous Loop (Max 5)
        Agent->>LLM: POST /v1/chat/completions<br/>(ëŒ€í™” ì´ë ¥ + Tools ì •ì˜)
        LLM-->>Agent: tool_calls: [{"name": "list_files", "args": {"path": "a.txt"}}]
        
        Agent->>Tools: list_files("a.txt") í˜¸ì¶œ
        
        alt íŒŒì¼ ì—†ìŒ (Error ë°œìƒ)
            Tools-->>Agent: {"success": false, "error": "file not found"}
            Note over Agent: ğŸ”„ Feedback Loop ì‘ë™
            Agent->>Agent: ì—ëŸ¬ ë¶„ì„ ë° í”¼ë“œë°± ë©”ì‹œì§€ ìƒì„±
            Agent->>LLM: "ì—ëŸ¬ ë°œìƒ: íŒŒì¼ ì—†ìŒ. ì–´ë–»ê²Œ í•´ê²°í• ë˜?"
            
            Note over LLM: í”¼ë“œë°± ìˆ˜ìš© ë° ìê°€ ìˆ˜ì •(Self-Correction)
            LLM-->>Agent: tool_calls: [{"name": "create_file", "args": {"filename": "a.txt"}}]
            
            Agent->>Tools: create_file("a.txt") í˜¸ì¶œ
            Tools-->>Agent: {"success": true, "message": "created"}
        else íŒŒì¼ ìˆìŒ
            Tools-->>Agent: {"success": true, "files": ["a.txt"]}
        end

        Agent->>LLM: ì‹¤í–‰ ê²°ê³¼ í¬í•¨í•˜ì—¬ ë‹¤ì‹œ í˜¸ì¶œ
    end

    LLM-->>Agent: "íŒŒì¼ì´ ì—†ì–´ì„œ ìƒì„± í›„ í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤."
    Agent-->>Void: ìµœì¢… ì‘ë‹µ (SSE Stream)
```

---

## 2. ìƒì„¸ ë‹¨ê³„ë³„ íë¦„

### 1ï¸âƒ£ Void IDE â†’ Agent Loop Server
- **íŒŒì¼**: `agent_native_loop/agent_native_loop_server.py`
- **ì—”ë“œí¬ì¸íŠ¸**: `POST /v1/chat/completions` (Port: 8002)
- ì‚¬ìš©ìì˜ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³  `chat_completions` í•¨ìˆ˜ì—ì„œ ììœ¨ ì‹¤í–‰ ë£¨í”„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.

### 2ï¸âƒ£ LLM Native Tool Calling (ì¶”ë¡  ë‹¨ê³„)
- ì„œë²„ëŠ” `native_loop_tools.py`ì— ì •ì˜ëœ ë„êµ¬ ëª©ë¡(`NATIVE_TOOL_DEFS`)ì„ LLMì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.
- LLMì€ í˜„ì¬ ì§ˆë¬¸ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì–´ë–¤ ë„êµ¬ê°€ í•„ìš”í•œì§€ íŒë‹¨í•©ë‹ˆë‹¤.

### 3ï¸âƒ£ Truly Native Loop (ì§ì ‘ ì‹¤í–‰)
- **ë¡œì»¬ í˜¸ì¶œ**: LLMì´ ìš”ì²­í•œ ë„êµ¬ë¥¼ ì™¸ë¶€ ì„œë²„ ê²½ìœ  ì—†ì´ ì„œë²„ ë‚´ë¶€ì˜ íŒŒì´ì¬ í•¨ìˆ˜ë¡œ ì¦‰ì‹œ ë§¤í•‘í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.
- **ì„±ëŠ¥**: ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œê°€ ì—†ìœ¼ë©°, `agent_native_loop_data.db`ì— í™œë™ ë‚´ì—­ì„ ì¦‰ì‹œ ê¸°ë¡í•©ë‹ˆë‹¤.

### 4ï¸âƒ£ í”¼ë“œë°± ë£¨í”„ ë° ìê°€ ìˆ˜ì • (í•µì‹¬ ì—”ì§„)
- **ì˜¤ë¥˜ ê°ì§€**: ë„êµ¬ ì‹¤í–‰ ê²°ê³¼ê°€ `success: False`ì¸ ê²½ìš° í”¼ë“œë°± ë£¨í”„ê°€ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.
- **í”¼ë“œë°± ì£¼ì…**: ì„œë²„ëŠ” LLMì—ê²Œ ë‹¨ìˆœ ì‹¤íŒ¨ê°€ ì•„ë‹Œ, **"ë„êµ¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: [ë‚´ìš©]. ì›ì¸ì„ ë¶„ì„í•˜ê³  í•„ìš”í•œ ê²½ìš° ìˆ˜ì •ëœ ì¸ìë¡œ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë°©ë²•ì„ ì°¾ì•„ì£¼ì„¸ìš”."**ë¼ëŠ” ê°€ì´ë“œë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
- **ìê°€ ìˆ˜ì •(Self-Correction)**: LLMì€ ì´ í”¼ë“œë°±ì„ ë°”íƒ•ìœ¼ë¡œ ìì‹ ì˜ ì‹¤ìˆ˜ë¥¼ ì¸ì§€í•˜ê³ , ë„êµ¬ ì¸ìë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜(ì˜ˆ: `ls` -> `create_file`) ìƒˆë¡œìš´ ì „ëµì„ ì„¸ì›Œ ì¬ì‹œë„í•©ë‹ˆë‹¤.

### 5ï¸âƒ£ ìµœì¢… ì‘ë‹µ ë°˜í™˜
- ëª¨ë“  ë„êµ¬ ì‹¤í–‰ ê²°ê³¼ê°€ ìˆ˜ì§‘ë˜ê³  LLMì´ ìµœì¢… ë‹µë³€ì„ í™•ì •í•˜ë©´, ì„œë²„ëŠ” ì´ë¥¼ SSE(Server-Sent Events) ìŠ¤íŠ¸ë¦¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ Void IDEë¡œ ì „ì†¡í•©ë‹ˆë‹¤.

---

## 3. í”¼ë“œë°± ë£¨í”„ ì‹¤ì œ ì‚¬ë¡€: `ls a.txt` ì¼€ì´ìŠ¤

ì‚¬ìš©ìë‹˜ê»˜ì„œ ì§ˆë¬¸í•˜ì‹  "íŒŒì¼ì´ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì„œ í•´ê²°í•˜ëŠ” ê³¼ì •"ì´ ë°”ë¡œ í”¼ë“œë°± ë£¨í”„ì˜ ì •ìˆ˜ì…ë‹ˆë‹¤.

> **ìƒí™©**: LLMì´ `list_files(path="a.txt")`ë¥¼ í˜¸ì¶œí–ˆìœ¼ë‚˜ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°

1.  **1ë‹¨ê³„ (LLM ìš”ì²­)**: "a.txt íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì¤˜." (`list_files` í˜¸ì¶œ)
2.  **2ë‹¨ê³„ (ì„œë²„ ì—ëŸ¬)**: ì„œë²„ê°€ ì‹¤í–‰í–ˆìœ¼ë‚˜ íŒŒì¼ì´ ì—†ìŒ â†’ `{"success": false, "error": "file not found"}` ë°˜í™˜.
3.  **3ë‹¨ê³„ (í”¼ë“œë°± ë£¨í”„)**: ì„œë²„ëŠ” LLMì—ê²Œ **"ì—ëŸ¬ê°€ ë‚¬ì–´. ì–´ë–»ê²Œ í• ë˜? íŒŒì¼ì„ ë§Œë“¤ì–´ì•¼ í• ê¹Œ, ì•„ë‹ˆë©´ ë‹¤ë¥¸ íŒŒì¼ì´ ìˆëŠ”ì§€ ì°¾ì•„ë³¼ê¹Œ?"**ë¼ê³  ë‹¤ì‹œ ì£¼ì…í•©ë‹ˆë‹¤.
4.  **4ë‹¨ê³„ (ìê°€ ìˆ˜ì •)**: LLMì€ í”¼ë“œë°±ì„ ë³´ê³  íŒë‹¨í•©ë‹ˆë‹¤. "ì•„, íŒŒì¼ì´ ì—†êµ¬ë‚˜. ê·¸ëŸ¼ ë‚˜í•œí…Œ `create_file` ë„êµ¬ê°€ ìˆìœ¼ë‹ˆê¹Œ ì´ê±¸ë¡œ ë§Œë“¤ê³  ë‹¤ì‹œ í™•ì¸í•´ì•¼ê² ë‹¤!"
5.  **5ë‹¨ê³„ (ì„±ê³µ)**: LLMì´ `create_file("a.txt")`ë¥¼ í˜¸ì¶œí•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.

> [!IMPORTANT]
> ì—¬ê¸°ì„œ **`create_file`ì€ 'ë„êµ¬'**ì´ê³ , ì—ëŸ¬ë¥¼ ë³´ê³  "ì•„, ê·¸ëŸ¼ íŒŒì¼ì„ ë§Œë“¤ì–´ì•¼ê² ë„¤!"ë¼ê³  **ìƒê°ì„ ë°”ê¿”ì„œ ë‹¤ì‹œ ì‹œë„í•˜ëŠ” ê³¼ì •ì´ 'í”¼ë“œë°± ë£¨í”„'**ì…ë‹ˆë‹¤.

---

## 4. í•µì‹¬ êµ¬ì„± íŒŒì¼ ë¹„êµ

| íŒŒì¼ëª… | ì—­í•  | ë¹„ê³  |
| :--- | :--- | :--- |
| **agent_native_loop_server.py** | ììœ¨ ë£¨í”„ ë° í”¼ë“œë°± ì—”ì§„ | í¬íŠ¸ 8002 |
| **native_loop_tools.py** | ì§ì ‘ ì‹¤í–‰ ë„êµ¬ ì •ì˜ | `create_file`, `list_files` í¬í•¨ |
| **agent_native_loop_config.json** | ì‹œìŠ¤í…œ ì„¤ì • | LLM ë° í¬íŠ¸ ì„¤ì • |
| **agent_native_loop_data.db** | í™œë™ ë° í”¼ë“œë°± ë¡œê·¸ | ìê°€ ìˆ˜ì • ê³¼ì • ì¶”ì  |
