# Agent Native Loop 아키텍처 (Architecture)

`agent_native_loop`는 기존 `agent_native`의 자율 실행 능력을 바탕으로, 오류 상황에서 에이전트가 스스로 판단하고 수정할 수 있는 **'능동적 자가 수정(Active Self-Correction)'** 능력이 강화된 모델입니다.

## 아키텍처 핵심 원리

### 1. 도구 호출 (Tool Use) 메커니즘
- **Truly Native**: MCP(Model Context Protocol) 서버와 같은 별도의 미들웨어 없이, Python 서버 내부에서 직접 도구(Functions)를 관리하고 실행합니다.
- **OpenAI 호환 규격**: Ollama나 vLLM 등에서 인식할 수 있는 표준 도구 정의(`tools/function`) 규격을 사용하여 범용성을 확보했습니다.
- **자동화된 실행기(Executor)**: 사용자의 개입 없이 서버가 LLM의 도구 호출 의도를 파악하고 즉시 실행한 뒤, 결과를 다시 입력(Observation)으로 주입합니다.

### 2. Human-in-the-Loop (HITL) 승인 시스템 🆕
도구 실행 전 사용자의 **명시적 승인**을 요구하는 안전장치입니다.

#### 동작 흐름
```
LLM 응답 → 도구 호출 감지 → 터미널에 승인 요청 출력 → y/n 입력 대기 → 승인 시 실행, 거절 시 루프 중단
```

#### 구현 상세
- **`ask_terminal_approval()`**: 도구 이름과 인자를 표시하고 사용자 입력 대기
- **승인 입력**: `y`, `yes`, `예`, `ㅛ` → 도구 실행 진행
- **거절 입력**: 그 외 모든 입력 → 도구 실행 건너뜀, 루프 즉시 종료
- **비동기 처리**: `asyncio.run_in_executor()`를 사용하여 이벤트 루프 블로킹 방지

#### 승인 요청 화면 예시
```
============================================================
🔧 도구 실행 승인 요청
   도구: read_file
   인자: {
     "filename": "a.txt"
   }
============================================================
실행하시겠습니까? (y/n): _
```

### 3. 피드백 루프 (Feedback Loop) 디자인
피드백 루프는 에이전트가 완벽하지 않은 환경이나 잘못된 판단에서도 목표를 달성하게 만드는 핵심 엔진입니다.

#### 루프 구조
- **Observation (관찰)**: 도구 실행 결과를 확인합니다.
- **Assessment (평가)**: 결과가 실패(`False`)인지 성공(`True`)인지 판단합니다.
- **Injection (주안점 주입)**: 실패 시, 모델이 '실패했다'는 사실을 인지하도록 프롬프트 레벨에서 피드백을 구성합니다.
  - *예: "도구 실행 중 오류가 발생했습니다: [에러내용]. 원인을 분석하고 다시 시도하세요."*
- **Reasoning (추론)**: 모델은 실패 원인을 분석(예: 인자 타입 불일치, 존재하지 않는 ID 등)하고 다음 행동을 결정합니다.

### 4. Graceful Shutdown (정상 종료) 🆕
서버 종료 시 포트가 정상적으로 해제되도록 하는 안정성 기능입니다.

#### 구현 상세
- **Signal Handler**: `SIGINT`(Ctrl+C), `SIGTERM` 시그널 처리
- **Graceful Timeout**: 5초 내 정상 종료 보장
- **종료 메시지**: 종료 시 상태 메시지 출력

#### 종료 시 출력 예시
```
^C
🛑 종료 신호 수신. 서버를 정상 종료합니다...
✅ 서버가 정상 종료되었습니다. 포트가 해제되었습니다.
```

## 프로젝트 구조

| 파일/디렉토리 | 설명 |
|---------------|------|
| `agent_native_loop_server.py` | 자율 실행 루프, 피드백 로직, HITL 승인 기능 포함 메인 엔진 |
| `native_loop_tools.py` | 에이전트가 사용하는 네이티브 도구 모음 및 테스트용 에러 도구 |
| `agent_native_loop_config/` | 독립적인 실행을 위한 설정 디렉토리 |
| `test_request.py` | API 테스트용 클라이언트 스크립트 |

## 장점
- **안전성**: HITL 승인 시스템으로 위험한 도구 실행을 사전에 방지할 수 있습니다.
- **신뢰성 향상**: 일시적인 오류나 모델의 사소한 실수로 인해 전체 프로세스가 중단되는 것을 방지합니다.
- **투명성**: 모든 피드백 과정이 DB와 로그에 기록되어 에이전트가 어떻게 문제를 해결했는지 추적할 수 있습니다.
- **자율성**: 사람이 개입하여 가이드를 주지 않아도 에이전트 스스로 최선의 답을 찾아갑니다.
- **안정성**: Graceful shutdown으로 서버 종료 시 포트가 정상 해제되어 좀비 프로세스 방지

## 실행 방법

```bash
# 서버 실행 (포트 8011)
cd agent_native_loop
python agent_native_loop_server.py

# 테스트 요청 (별도 터미널에서)
python test_request.py
```

> ⚠️ **주의**: 도구 호출 시 **서버 터미널**에서 승인 입력(y/n)이 필요합니다.
